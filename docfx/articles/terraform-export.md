# Terraform Export

**Highly experimental!**

## Disclaimer

A polite reminder of the MIT license terms.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

Baiscally, if you damage an existing production system by applying terraform configuration generated by this tool, that is your problem. This tool serves as an _aid_ in migrating a CloudFormation stack to terraform, _not_ a de-facto solution.

You are stongly advised to deploy a copy of a production stack elsewhere, export that, then manually edit the configuration generated by this tool and apply to your test stack until you obtain the desired results.

## About

Given a scenario where your organisation has dictated that all native CloudFormation stacks should be migrated to Terraform, this cmdlet goes some way to easing the pain of that operation. Currently [terraform import](https://www.terraform.io/docs/cli/import/index.html) does not generate [HCL](https://www.terraform.io/docs/language/index.html) code for imported resources, only state information leaving the user to work out and add in all the attributes for every imported resource.

The [Export-PSCFNTerraform](xref:Export-PSCFNTerraform) cmdlet will read a CloudFormation Stack via the AWS CloudFormation Service and make a best attempt at generating HCL for the resources the stack contains. Additionally it will try to fix up dependencies between these resources, input variables (stack parameters) and output values as best it can. Thus the amount of work to be done in getting the HCL for the stack correct is greatly reduced.

The general procedure for migrating a CloudFormation Stack is as follows

1. Run [Export-PSCFNTerraform](xref:Export-PSCFNTerraform) on the stack, and make manual corrections. Test deploy your terraform stack to another environment/region/account until you're sure it's correct.
1. Edit the CloudFormation Template and set a `DeletionPolicy` of `Retain` on all resources. Update the stack and ensure that this gets applied. In some cases you might need to force a resource update to one resouce (e.g. add a tag) for these policies to be applied.
1. Delete the CloudFormation Stack. The stack definition will be removed from CloudFormation, however the resouces it contains will not.
1. Now the stack resources are wholly owned by Terraform.

## Caveats

### Resource Types
* Currently this tool recognises the relationship between about 380 AWS resources and their Terraform equivalents. That's probably about half of what can actually be matched.
* There are still some AWS resources for which an equivalent resource has not yet been added to the Terraform AWS provider. `AWS::SecretsManager::SecretAttachment` at the time of writing and being one I use frequently with RDS stacks.

### Embedded scripts and code (provisioners, lambda)
* `AWS::CloudFormation::Init` data attached to resources is not exported because Terraform does not have this concept. Where init data is found, a warning is issued against the imported resource. Such scripts need refactoring to user data or some other mechanism.
* User Data import - `terraform import` seems to make a hash (literally) of user data properties imported from launch configurations (and propbably instances too). You will need to correct that in the generated HCL or `terraform apply` is going to wipe out your user data script.<br/> Having said that, many user data scripts contain CloudFormation specific commands such as calls to `cfn-init` and references to CloudFormation specific pseudo-parameters which may hold little relevance in a terraform-managed stack.<br/>Whre user data is found, a warning is issued.
* Lambda - Embedded function code declared in the CloudFormation Template with `ZipFile` isn't supported by Terraform. This code should be extracted from the CloudFormation, placed into a local file and added to the terraform configuration with an `aws_s3_bucket_object` resource to upload it.<br/> Where inline code is found, a warning is issued.

### Imported Resources

* The existing resources in a deployed CloudFormation Stack are imported. If the CloudFormation Template that deployed the stack contains conditional resources which may not be instantiated at the time this tool is run, those resources won't be imported to Terraform. If you want the full functionality of the original CloudFormation template, that has to be added manually.

### Output Values

* In CloudFormation, the value returned by `!Ref` is not necessarily the primary identifier of the resource. Sometimes its a name, sometimes its an ARN, sometimes it's some other attribute. This tool will not always get that right.


## Future Improvements

* Increase the number of mapped resources.
* Make the exporter recursive through nested stacks, producing a Terraform module for each nested stack.
* Learn GoLang and become a contributor to the Terraform AWS provider üòÅ

